stages:
- dependencies
- build
- build-package

.arch_amd64-template: &arch_amd64-template
  image: iqrfsdk/iqrf-gateway-daemon-build:latest-amd64
  variables:
    ARCH: "amd64"
  tags:
  - linux, amd64

.arch_arm64-template: &arch_arm64-template
  image: iqrfsdk/iqrf-gateway-daemon-build:latest-arm64
  variables:
    ARCH: "arm64"
  tags:
  - linux, arm64

.arch_armhf-template: &arch_armhf-template
  image: iqrfsdk/iqrf-gateway-daemon-build:latest-armhf
  variables:
    ARCH: "armhf"
  tags:
  - linux, armhf

.daemon-template: &daemon-template
  stage: build
  before_script:
  - eval $(ssh-agent -s)
  - echo "$GIT_SSH_PRIVATE" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
  - export DAEMON_VERSION=v2.0.0-beta
  - export DAEMON_VERSION_NUM=2.0.0-beta
  - git clone ssh://git@gitlab.iqrfsdk.org:2222/gateway/iqrf-daemon.git iqrf-daemon-source
  - git -C iqrf-daemon-source submodule init
  - git -C iqrf-daemon-source submodule update
  - mkdir iqrf-daemon-build iqrf-daemon-deploy
  - tar xzvf shape-source_${ARCH}.tar.gz
  - tar xzvf shape-build_${ARCH}.tar.gz
  - tar xzvf shapeware-source_${ARCH}.tar.gz
  - tar xzvf shapeware-build_${ARCH}.tar.gz
  - cmake -Biqrf-daemon-build -Hiqrf-daemon-source -Dshape_DIR:PATH=../shape-build -Dshapeware_DIR:PATH=../../shapeware-build -DDAEMON_VERSION:STRING=${DAEMON_VERSION}
  - cmake --build iqrf-daemon-build

.package-template: &package-template
  stage: build-package
  before_script:
  - eval $(ssh-agent -s)
  - echo "$GIT_SSH_PRIVATE" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  - git checkout -B "$CI_COMMIT_REF_NAME" "$CI_COMMIT_SHA"
  - git submodule init
  - git submodule update
  script:
  - export DAEMON_VERSION=v2.0.0-beta
  - export DAEMON_VERSION_NUM=2.0.0-beta
  - tar xzvf shape-source_${ARCH}.tar.gz
  - tar xzvf shape-build_${ARCH}.tar.gz
  - tar xzvf shapeware-source_${ARCH}.tar.gz
  - tar xzvf shapeware-build_${ARCH}.tar.gz
  - gbp dch -a -S --snapshot-number="$CI_PIPELINE_ID" --ignore-branch
  - dpkg-buildpackage -b -rfakeroot -us -uc -tc
  - cp ../iqrf-gateway-daemon*.deb .
  artifacts:
    paths:
    - iqrf-gateway-daemon*.deb
    expire_in: 2 weeks

.shape_shapeware-template: &shape_shapeware-template
  stage: dependencies
  dependencies: []
  script:
  - git clone https://github.com/logimic/shape.git shape-source
  - mkdir shape-build shape-libs
  - cmake -Bshape-build -Hshape-source
  - cmake --build shape-build
  - bash .gitlab_build_files/copy_shape_libs.sh shape-libs
  - tar czvf shape-source_${ARCH}.tar.gz shape-source
  - tar czvf shape-build_${ARCH}.tar.gz shape-build
  - tar czvf shape-libs_${ARCH}.tar.gz shape-libs
  - git clone https://github.com/logimic/shapeware.git shapeware-source
  - git -C shapeware-source submodule init
  - git -C shapeware-source submodule update
  - mkdir shapeware-build shapeware-libs
  - cmake -Bshapeware-build -Hshapeware-source -Dshape_DIR:PATH=../shape-build -DLWS_STATIC_PIC:BOOL=true -DLWS_WITH_SSL:BOOL=false
  - cmake --build shapeware-build
  - bash .gitlab_build_files/copy_shapeware_libs.sh shapeware-libs
  - tar czvf shapeware-source_${ARCH}.tar.gz shapeware-source
  - tar czvf shapeware-build_${ARCH}.tar.gz shapeware-build
  - tar czvf shapeware-libs_${ARCH}.tar.gz shapeware-libs
  artifacts:
    paths:
    - shape-source_*.tar.gz
    - shape-build_*.tar.gz
    - shapeware-source_*.tar.gz
    - shapeware-build_*.tar.gz
    expire_in: 2 weeks

#AMD64

shape_&_shapeware-amd64:
  <<: *arch_amd64-template
  <<: *shape_shapeware-template

daemon-amd64:
  <<: *arch_amd64-template
  <<: *daemon-template
  dependencies:
  - shape_&_shapeware-amd64

package-amd64:
  <<: *arch_amd64-template
  <<: *package-template
  dependencies:
  - shape_&_shapeware-amd64

#ARMHF

shape_&_shapeware-armhf:
  <<: *arch_armhf-template
  <<: *shape_shapeware-template

daemon-armhf:
  <<: *arch_armhf-template
  <<: *daemon-template
  dependencies:
  - shape_&_shapeware-armhf

package-armhf:
  <<: *arch_armhf-template
  <<: *package-template
  dependencies:
  - shape_&_shapeware-armhf

#ARM64

shape_&_shapeware-arm64:
  <<: *arch_arm64-template
  <<: *shape_shapeware-template

daemon-arm64:
  <<: *arch_arm64-template
  <<: *daemon-template
  dependencies:
  - shape_&_shapeware-arm64

package-arm64:
  <<: *arch_arm64-template
  <<: *package-template
  dependencies:
  - shape_&_shapeware-arm64
